#!/bin/bash
# Sets up a new dmux worktree: uv sync, copy .env (postgres mode), symlink data
set -euo pipefail

cd "$DMUX_WORKTREE_PATH"

# Install Python deps
if command -v uv &> /dev/null && [ -f "pyproject.toml" ]; then
  uv sync &
fi

# Copy .env and override backend to postgres (DuckDB only allows one writer)
if [ -f "$DMUX_ROOT/.env" ]; then
  cp "$DMUX_ROOT/.env" "$DMUX_WORKTREE_PATH/.env"
  # Force postgres backend so worktrees don't fight over DuckDB locks
  if grep -q "^SWORD_PRIMARY_BACKEND=" "$DMUX_WORKTREE_PATH/.env"; then
    sed -i '' 's/^SWORD_PRIMARY_BACKEND=.*/SWORD_PRIMARY_BACKEND=postgres/' "$DMUX_WORKTREE_PATH/.env"
  else
    echo "SWORD_PRIMARY_BACKEND=postgres" >> "$DMUX_WORKTREE_PATH/.env"
  fi
fi

# Symlink data dirs (read-only access to DuckDB for queries/comparisons)
mkdir -p "$DMUX_WORKTREE_PATH/data"
for dir in duckdb netcdf; do
  if [ -d "$DMUX_ROOT/data/$dir" ] && [ ! -e "$DMUX_WORKTREE_PATH/data/$dir" ]; then
    ln -s "$DMUX_ROOT/data/$dir" "$DMUX_WORKTREE_PATH/data/$dir"
  fi
done
