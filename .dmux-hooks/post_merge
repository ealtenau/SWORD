#!/bin/bash
# Push to remote after merge; close GitHub issue if referenced in prompt
set -euo pipefail

cd "$DMUX_ROOT"

# Never push directly to main
if [ "$DMUX_TARGET_BRANCH" = "main" ] || [ "$DMUX_TARGET_BRANCH" = "master" ]; then
  echo "[Hook] Refusing to push directly to main â€” open a PR instead." >&2
  exit 1
fi

# Push merged branch to remote
git push origin "$DMUX_TARGET_BRANCH"

# Close GitHub issue if prompt contains #123 format
ISSUE_NUM=$(echo "$DMUX_PROMPT" | grep -oE '#[0-9]+' | head -1 | tr -d '#' || true)
if [ -n "$ISSUE_NUM" ] && command -v gh &> /dev/null; then
  gh issue close "$ISSUE_NUM" \
    -c "Resolved in $DMUX_SLUG, merged to $DMUX_TARGET_BRANCH" \
    2>/dev/null || true
fi
