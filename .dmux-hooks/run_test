#!/bin/bash
# Run pytest and report status to dmux UI
set -euo pipefail

cd "$DMUX_WORKTREE_PATH"
API_URL="http://localhost:$DMUX_SERVER_PORT/api/panes/$DMUX_PANE_ID/test"

# Report: running
curl -s -X PUT "$API_URL" \
  -H "Content-Type: application/json" \
  -d '{"status": "running"}' > /dev/null

OUTPUT_FILE="/tmp/dmux-test-$DMUX_PANE_ID.txt"

# Run targeted tests (sword_duckdb, skip slow/postgres by default)
if uv run pytest tests/sword_duckdb/ -q --tb=short -m "not slow and not postgres" > "$OUTPUT_FILE" 2>&1; then
  STATUS="passed"
else
  STATUS="failed"
fi

OUTPUT=$(head -c 5000 "$OUTPUT_FILE")

# Report: result
curl -s -X PUT "$API_URL" \
  -H "Content-Type: application/json" \
  -d "$(jq -n \
    --arg status "$STATUS" \
    --arg output "$OUTPUT" \
    '{status: $status, output: $output}')" > /dev/null

rm -f "$OUTPUT_FILE"

[ "$STATUS" = "passed" ]
